<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Demo: Layout with Dijit</title>
    <link rel="stylesheet" href="codemirror-4.8/lib/codemirror.css" />
    <!-- <link rel="stylesheet" href="codemirror-4.8/theme/default.css" /> -->
    <script src="codemirror-4.8/lib/codemirror.js"></script>
    <script src="codemirror-4.8/addon/edit/matchbrackets.js"></script>
    <script src="codemirror-4.8/mode/clike/clike.js"></script>
    <script src="codemirror-4.8/mode/coffeescript/coffeescript.js"></script>
    <link rel="stylesheet" href="style.css" media="screen">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/dojo/1.10.2/dijit/themes/claro/claro.css" media="screen">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  </head>
  <body class="claro" style="opacity: 0">
    <!-- Tags end on line afterwards to eliminate any whitespace -->
    <div id="toolbar1" data-dojo-type="dijit/Toolbar" class="flat"
      ><input type="file"
          data-dojo-type="dijit/form/Button" id="toolbar1.open"
          data-dojo-props="iconClass:'fa fa-download', showLabel:false"
      /><span data-dojo-type="dijit/ToolbarSeparator"
      ></span><div data-dojo-type="dijit/form/Button" id="toolbar1.run"
          data-dojo-props="iconClass:'fa fa-play', showLabel:false, onClick:runCode">Run</div
      ><div data-dojo-type="dijit/form/Button" id="toolbar1.pause"
          data-dojo-props="iconClass:'fa fa-pause', showLabel:false">Pause</div
      ><div data-dojo-type="dijit/form/Button" id="toolbar1.stepOver"
          data-dojo-props="iconClass:'fa fa-long-arrow-right', showLabel:false">Step over</div
      ><div data-dojo-type="dijit/form/Button" id="toolbar1.stepInto"
          data-dojo-props="iconClass:'fa fa-level-down', showLabel:false">Step into</div
      ><div data-dojo-type="dijit/form/Button" id="toolbar1.stepOut"
          data-dojo-props="iconClass:'fa fa-level-up', showLabel:false">Step out</div
      >
    </div>
    <div id="appLayout" class="demoLayout"
        data-dojo-type="dijit/layout/BorderContainer"
        data-dojo-props="design: 'headline'">
      <!-- <div class="nochrome"
          data-dojo-type="dijit/layout/ContentPane"
          data-dojo-props="region: 'center'"> -->
        <div
            data-dojo-type="dijit/layout/BorderContainer"
            data-dojo-props="design: 'headline', region: 'center'">
          <!-- <div class="centerPanel nochrome"
              data-dojo-type="dijit/layout/ContentPane"
              data-dojo-props="region: 'center'"> -->
            <div data-dojo-props="region: 'center'" data-dojo-type="dijit/layout/TabContainer" id="tabs" style="width: 100%; height: 100%;">
              <div class="nochrome" data-dojo-type="dijit/layout/ContentPane" title="Tool" data-dojo-props="selected:true">
                <textarea id="code" name="code"></textarea>
              </div>
              <div class="nochrome" data-dojo-type="dijit/layout/ContentPane" title="asm" data-dojo-props="selected:true">
                <textarea id="asm" name="asm"></textarea>
              </div>
              <script type="dojo/method">initTabs();</script>
            </div>
          <!-- </div> -->
          <pre id="console" class="edgePanel"
              data-dojo-type="dijit/layout/ContentPane"
              data-dojo-props="region: 'bottom', splitter: true"></pre>
        <!-- </div> -->
      </div>
      <!-- <div id="leftCol" class="edgePanel nochrome"
          data-dojo-type="dijit/layout/ContentPane"
          data-dojo-props="region: 'right', splitter: true"> -->
        <div id="leftCol"
            data-dojo-type="dijit/layout/BorderContainer"
            data-dojo-props="design: 'headline', region: 'right', splitter: true">
          <div id="variablesPanel" class="edgePanel"
              data-dojo-type="dijit/layout/ContentPane"
              data-dojo-props="region: 'center'">
          </div>
          <div id="breakpointsPanel" class="edgePanel"
              data-dojo-type="dijit/layout/ContentPane"
              data-dojo-props="region: 'top', splitter: true">
            Breakpoints
          </div>
        </div>
      <!-- </div> -->
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/dojo/1.10.2/dojo/dojo.js" data-dojo-config="async:true, parseOnLoad: true"></script>
    <script src="underscore.js"></script>
    <script src="log.js"></script>
    <script src="Engine.js"></script>

    <script src="browserfs.js"></script>
    <script type="text/javascript">
      BrowserFS.install(window);

      var lsfs = new BrowserFS.FileSystem.LocalStorage();
      // Initialize it as the root file system.
      BrowserFS.initialize(lsfs);


      // export fs object
      var fs = require('fs');

      fs.writeFile('/test.txt', 'object BinarySearch {\n    df main(): Unit = {\n        println(new BS().Start(20));\n    }\n}\n\n// This class contains an array of integers and\n// methods to initialize, print and search the array\n// using Binary Search\nclass BS {\n    var number : Int[];\n    var size : Int;\n\n    /* Invoke methods to initialize, print and search\n       for elements on the array **/\n    def Start(sz : Int) : String = {\n        var b: Bool;\n        \n        return "bar";\n    }\n}', function(err) {
        if (err) throw err;
      });

      // (function() {
      //   var legacy = window.console;

      //   var scalaGlobal = {
      //     log: function(msg) {
      //       log.info(msg);
      //       legacy.log.apply(legacy, arguments);
      //     },
      //     error: function(msg) {
      //       log.error(msg);
      //       legacy.error.apply(legacy, arguments);
      //     }
      //   }
      // })();

      var scalaGlobal = {
        window: _.extend({
          console: {
            log: function(msg) {
              log.info(msg);
              legacy.log.apply(legacy, arguments);
            },
            error: function(msg) {
              log.error(msg);
              legacy.error.apply(legacy, arguments);
            }
          }
        }, window)
      };

    </script>
    <script src="tool-compiler-fastopt.js"></script>


    <script>
      require(["dijit/registry", "dijit/layout/BorderContainer",
          "dijit/layout/TabContainer", "dijit/layout/ContentPane",
          "dijit/MenuBar", "dijit/MenuBarItem", "dijit/PopupMenuBarItem",
          "dijit/DropDownMenu", "dijit/MenuItem",
          "dojo/domReady!"
        ],
        function(registry, BorderContainer, TabContainer, ContentPane, MenuBar) {

          document.body.setAttribute('style', '');

          window.initTabs = function() {
            var tabs = registry.byId('tabs');
            tabs.watch("selectedChildWidget", function(name, oval, nval){
              editor.refresh();
              asmEdit.refresh();
            });
          };

          window.runCode = function() {
            fs.writeFile('/test.tool', editor.getValue(), function(err) {
              if (err) throw err;
              try {
                with (scalaGlobal) {
                  toolc.Main()
                    .entry('/test.tool');
                }
              } catch (e) {
                console.error(e);
                // console.error(e.stackdata.stack);
              }
            });
          };

          var engine = new Engine();

          var myTextArea = document.getElementById("code");
          var editor = CodeMirror(function(elt) {
            myTextArea.parentNode.replaceChild(elt, myTextArea);
          }, {
            lineNumbers: true,
            matchBrackets: true,
            theme: "default",
            mode: "text/x-scala",
            gutters: [
              'CodeMirror-linenumbers',
              'breakpoints'
            ]
          });

          var asmTextArea = document.getElementById("asm");
          var asmEdit = CodeMirror(function(elt) {
            asmTextArea.parentNode.replaceChild(elt, asmTextArea);
          }, {
            lineNumbers: true,
            readOnly: true,
            theme: "default",
            mode: "coffeescript",
            value: "# --- main ---\n\n\tnew Tester\n\tinvoke Test 0\n\tprintln\n\n# --- class Tester ---\n\n# getThreshold\n\n\tpush 0\n\tret\n\n# Concat\n\n\tpush s\n\tpush i\n\tbin +\n\tret\n\n# Test\n\n\tpush p\n\tlength\n\tpush 1\n\tbin -\n\tpop i\n\nloop0:\n\tpush i\n\tpush this\n\tinvoke getThreshold 0\n\tbin <=\n\tunary !\n\tje afterLoop0\n\tpush this\n\tpush t\n\tpush i\n\tinvoke concat 2\n\tpush i\n\tpush 1\n\tbin -\n\tpop i\n\tjp loop0\n\nafterLoop0:\n\tpush t\n\tret",
            gutters: [
              'CodeMirror-linenumbers',
              'breakpoints'
            ]
          });

          editor.on("gutterClick", function(cm, n) {
            var info = cm.lineInfo(n);
            cm.setGutterMarker(n, "breakpoints", info.gutterMarkers ? null : makeMarker());
          });

          function makeMarker() {
            var marker = document.createElement("div");
            marker.style.color = "#822";
            marker.innerHTML = "●";
            return marker;
          }


          // Start-up refresh
          window.setTimeout(function() {
            editor.refresh();

            var open = document.getElementById('toolbar1.open').parentElement.nextSibling;
            open.addEventListener('change', function() {
              openFiles(this.files);
            });
          }, 500);

          function openFiles(files) {
            if (files.length < 1) {
              alert('No file selected, aborting');
            }
            var file = files[0];
            var fr = new FileReader();

            fr.addEventListener('loadend', function() {
              try {
                var progName = file.name.substr(0, file.name.lastIndexOf('.'));
                log.info('Loading programm '+progName);

                var parsed = JSON.parse(fr.result);
                editor.setValue(parsed.text);

                engine.load(parsed);

                asmEdit.setValue(engine.getProgramAsText());

                log.info('Detected '+Object.keys(parsed.classes).length+' classes.');

                log.success('Program '+progName+' successfully loaded!');
              } catch(e) {
                log.error('Cannot parse input file '+file.name);
                throw e;
              }
            });

            fr.readAsText(file);
          }

          log('\t### Tool debugger v0.0 ###\n\n');
          log('No file loaded, click the load icon to load a file');
        });
    </script>
  </body>
</html>